# Everything goes into ElasticSearch
<label @FWD>

# MongoDB records don't have level, so we'll add level manually.
  <filter osp.var.log.mongodb.**>
    @type record_transformer
    <record>
      level info
    </record>
  </filter>


# Parser test
  <filter nosp.**>
    @type parser
    reserve_data yes
    format grok
    grok_pattern %{OSLO_WITHCONTEXT}
    custom_pattern_path /etc/fluent/patterns.d
    key_name message
  </filter>

# Fluentd records have level in tag. e.g. fluent.warn
  <filter fluent.**>
    @type record_transformer
    enable_ruby
    <record>
      level ${tag_parts[1] == "warn" ? "warning" : tag_parts[1] == "error" ? "err" : tag_parts[1] == "fatal" ? "crit" : tag_parts[1]}
    </record>
  </filter>

# Normalize level
  <filter osp.**>
    @type record_transformer
    enable_ruby
    auto_typecast true
    <record>
      level ${level == "WARNING" ? "warning" : level == "ERROR" ? "err" : level == "DEBUG" ? "debug" : (level == "INFO" || level == "") ? "info" : level}
    </record>
  </filter>

# Add Normalizer info
  <filter **>
    @type record_transformer
    enable_ruby
    auto_typecast true
    <record>
      normalizer {"hostname": "asherkho-centos7-normalizer.os1.phx2.redhat.com", "inputname": "forward", "name": "fluentd-normalizer"}
    </record>
  </filter>
  <filter **>
    @type record_transformer
    enable_ruby
    auto_typecast true
    <record>
      pipeline_metadata {"normalizer": {"hostname": "asherkho-centos7-normalizer.os1.phx2.redhat.com", "inputname": "forward", "name": "fluentd-normalizer"}, "@version": "2016.03.10.0", "received_at" : "${Time.now.utc.strftime(\"%Y-%m-%dT%H:%M:%S.%6N\")}"}
    </record>
    remove_keys normalizer
  </filter>
  <match osp.**>
    @type            elasticsearch
    hosts            elasticsearch:80
    logstash_format  true
    include_tag_key  true
    tag_key          fluentd:tag
    flush_interval   1s
    logstash_prefix  v2016.03.10.0-viaq
    type_name        openstack
    request_timeout  120s
  </match>
  <match **>
    @type            elasticsearch
    hosts            elasticsearch:80
    logstash_format  true
    include_tag_key  true
    tag_key          fluentd:tag
    flush_interval   1s
    logstash_prefix  v2016.03.10.0-viaq
    type_name        fluentd
    request_timeout  120s
  </match>
</label>
